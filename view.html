<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Welcome</title>
    <script src="https://cdn.socket.io/3.1.1/socket.io.min.js"
            integrity="sha384-gDaozqUvc4HTgo8iZjwth73C6dDDeOJsAgpxBcMpZYztUfjHXpzrpdrHRdVp8ySO"
            crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<style>
    html, body {
        height: 100%;
        background-color: rgb(0,200,255);
    }

    .main-image {
        display: none;
        position: relative;
        overflow: hidden;
        height: 100%;
        background-position: center center;
        background-repeat: no-repeat;
    }
    #img-two{
        position: absolute;
        right: 10%;
        top: 50%;
        display: none;
    }
    #img-three{
        position: absolute;
        right: 20%;
        top: 60%;
        display: none;
    }
    .animate{
        transition: all ease-in 3s;
    }
</style>
<body>
<form id="form">
    <input type="text" name="cId" placeholder="enter iPAD id">
    <input type="submit" value="go">
</form>
<section class="main-image" id="target">
        <img id="img-two" alt="bird two" src="/images/Flying_Bird/Bird1.png"/>
        <img id="img-three" alt="bird two" src="/images/Flying_Bird/Bird1.png"/>
</section>


<script>
    /*
    * Section 1: set up control of visible HTML & JavaScript
    * */
    const delay = 3000;
    const imageContainer = document.getElementById('target');
    const img2 = document.getElementById('img-two');
    const img3 = document.getElementById('img-three');

    // read in cId (tablet identifier)
    const cId = window.location.search.substr(1).split("=")[1];

    let socket;
    let iPadBird;

    /*
    * Setup for pixel animation with touch mode:
    * prepare animated gif
    * */
    const gif = document.createElement('img');
    gif.src = '/images/bird.gif';
    gif.className = 'animate';

    /*
    * Setup for single cell animation mode:
    *
    * */
    function renderImage(data) {
        iPadBird = data.data.src;
        imageContainer.style.backgroundImage = 'url("/images/' + data.data.src + '")';
        img2.src = '/images/' + data.data.src;
        img3.src = '/images/' + data.data.src;
    }


    function getUpdatedImage() {
        axios.get('/image/' + cId).then(renderImage);
    }

    /*
    * Section 2: handle click/touch events
    * handles touch position in order to influence/start animation
    *
    * */
    let moving = true;
    let iPadContainsBird = false;
    let leaveEmit;
    imageContainer.addEventListener('click', (ev) =>{
        if(!iPadContainsBird){
            return;
        }
        clearTimeout(leaveEmit);
        gif.style.top = ev.clientY + 'px';
        gif.style.left = ev.clientX + 'px';
        setTimeout(()=>{

            fly(ev.clientY + 'px')
        }, delay);
        console.log(ev)
    })
    // animation path & socket communication
    function fly(startY){
        // gif.style.left = 'calc(100vw + 138px)';
        gif.style.left = 'calc(100vw + 138px)';
        gif.style.top = startY;
        leaveEmit = setTimeout(()=>{
            socket.emit("leave",{cId: Number(cId), y: startY})
            iPadContainsBird = false;
        },delay - 300)
    }

    /*
    * End Section 2
    *
    * */

    /*
    * Section 3: listening for speed, mode and position
    * */
    function setup() {
        getUpdatedImage()
        console.log("Setting up socket")

        socket = io()


        if (socket !== undefined) {
            // Registers single tablet with the server (+ basic display)
            socket.on('connect', fb => {
                if(cId){
                    document.getElementById('form').style.display = 'none';
                    imageContainer.style.display = 'block';
                }
                console.log('Connected as IPAD ' + cId);
                socket.emit("cId",{cId:Number(cId)})
            })
            // react on enter event:
            // check whether current tablet is supposed to start animation and execute it if applicable
            socket.on("enter", (message)=>{
                console.log("enter", message)
                if(message.cId === Number(cId)){
                    iPadContainsBird = true;
                    // initiate interactive bird rendering
                    renderStatic(message.y, '-138px');
                    // fly animation
                    setTimeout(()=>fly(message.y),50)
                }
            })
            // listen to change in speed of accelerometer
            socket.on("changeImage", (message) => {

                /*
                * Case three birds are shown
                * */
                if (message.speed.x < -0.26) {
                    moving = true;
                    imageContainer.style.backgroundSize = '50%';
                    imageContainer.style.backgroundPosition = 'top left';
                    img2.style.display = 'block';
                    img2.style.top = '30%'
                    img2.style.transform = 'scale(1)';
                    img3.style.display = 'block';

                } else if (message.speed.x < -0.1) {
                    /*
                    * Case two birds are shown
                    * */
                    moving = true;
                    imageContainer.style.backgroundSize = '60%';
                    imageContainer.style.backgroundPosition = 'center top';
                    img2.style.display = 'block';
                    img2.style.transform = 'scale(1.2)';
                    img3.style.display = 'none';
                    img2.style.top = '50%'
                    removeSingleBird()
                } else if(message.speed.x < -0.01) {
                    /*
                    * Case one birds is shown
                    * */
                    moving = true;
                    imageContainer.style.backgroundSize = 'contain';
                    img2.style.display = 'none';
                    img3.style.display = 'none';
                    removeSingleBird()
                } else {
                    /*
                    * Case pixel animation with touch
                    * */
                    if(moving){
                        
                        imageContainer.style.backgroundImage = 'none';
                        if(Number(cId) === 0){
                            renderStatic('calc(50% - 48px)');
                            iPadContainsBird = true;
                        }

                        moving = false;
                    }

                }
            })

        }
    }
    // clear state between modes
    function removeSingleBird(){
        gif.style.display = "none";
        imageContainer.style.backgroundImage = 'url("/images/' + iPadBird + '")'
    }

    // positioning interactive bird based on socket and previous position
    function renderStatic(y, x = '0px'){
        gif.style.display = "block";
        gif.width = 138;
        gif.height = 96;
        gif.style.position = 'absolute';
        gif.style.top = y;
        gif.style.left = x;
        imageContainer.appendChild(gif);
    }

    setup();

</script>
</body>
</html>
